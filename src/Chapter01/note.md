# 第一章 简介

为什么要编写并发程序？

* 线程是Java语言中不可或缺的重要功能，他们能使复杂的异步代码变得简单，从而极大地简化了复杂系统的开发。
* 此外，要想发挥多处理器系统的强大计算能力，最简单的方式就是使用线程。

## 1.1并发简史

* 在早期的计算机中不包含操作系统，他们从头到尾只执行一个程序，并且这个程序能访问计算机中的所有资源。在这种裸机环境中，不仅很难编写和运行程序，而且每次只能运行一个程序，这对于昂贵并且稀有的计算机资源来说也是一种浪费。

* 操作系统的出现使得计算机每次能运行多个程序，并且不同的程序都在单独的进程中运行：**操作系统为各个独立执行的进程分配各种资源，包括内存、文件句柄以及安全证书等**。如果需要的话，在不同进程之间可以通过一些粗粒度的通信机制来交换数据，包括：**套接字、信号处理器、共享内存、信号量以及文件等**。

* 在计算机中加入操作系统来实现多个程序的同时执行，主要基于以下原因：

  1.  **资源利用率**

     在某些情况下，程序必须等待某个外部操作执行完成。如果在等待的同时可以运行另一个程序，那么无疑将提高资源的利用率。

  2.  **公平性**

     不同用户和程序对于计算机上的资源有着同等的使用权。一种高效的运行方式是通过粗粒度的**时间分片（Time Slicing）**使这些用户和程序能共享计算机资源，而不是由一个程序从头运行到尾，然后再启动下一个程序。

  3.  **便利性**

     通常来说，在计算多个任务时，应该编写多个程序，每个程序执行一个任务并在必要时相互通信，这比只编写一个程序来计算所有任务更容易实现。
  
* 在早期的分时系统中，每个进程相当于一台虚拟的冯诺依曼计算机，它拥有存储指令和数据的内存空间，根据机器语言的语义以串行方式执行指令，并通过一组I/O指令与外部设备通信。对每条被执行的指令，都有相应的“下一条指令”，**程序中的控制流是按照指令集的规则来确定的**。当前，几乎所有的主流编程语言都遵循这种串行编程的模型，并且在这些语言的规范中都清晰地定义了在某个动作完成之后需要执行的“下一个动作”。

* 线程允许在同一个进程中同时存在多个**程序控制流**。线程会共享进程范围内的资源，例如内存句柄和文件句柄，但每个线程都具有各自的程序计数器（Program Counter）、栈以及局部变量等。线程还提供了一种直观的**分解模式**来充分利用多处理器系统中的硬件并行性，而在同一个程序中的多个线程也可以被同时调度到多个CPU上运行。

* 线程也被称为轻量级进程。在大多数现代操作系统中，都是以线程为基本的调度单位。

  * 由于同一个进程中的所有线程都将共享进程的内存地址空间，因此这些线程都能访问相同的变量并在一个堆上分配对象，这就需要实现一种比在进程间共享数据粒度更细的数据共享机制。如果没有明确的**同步机制**来协同对共享数据的访问，那么当一个线程正在使用某个变量时，另一个线程可能同时访问这个变量，这将造成不可预测的结果。

